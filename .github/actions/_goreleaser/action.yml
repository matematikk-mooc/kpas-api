# GoReleaser Action
# Runs GoReleaser to build and release Go binaries
# Copy to other projects: .github/actions/_goreleaser/
#
# Features:
#   - Creates GitHub releases with multi-arch binaries
#   - Supports prereleases with auto-generated tags
#   - Configurable release title and notes
#   - Snapshot mode for testing
#
# Tag Generation (when tag input is empty and prerelease is true):
#   - Format: _stage-YYYYMMDD-rcN (underscore prefix sorts below real versions)

name: 'GoReleaser'
description: 'Build and release Go binaries using GoReleaser'

inputs:
  github-token:
    description: 'GitHub token for releases'
    required: true
  version:
    description: 'GoReleaser version'
    required: false
    default: '~> v2'
  args:
    description: 'GoReleaser arguments'
    required: false
    default: 'release --clean'
  # Tag options
  tag:
    description: 'Explicit tag to release (auto-generated for prereleases if empty)'
    required: false
    default: ''
  tag-prefix:
    description: 'Tag prefix for auto-generated prerelease tags'
    required: false
    default: '_stage'
  # Release type options
  prerelease:
    description: 'Mark as prerelease'
    required: false
    default: 'false'
  draft:
    description: 'Create as draft release'
    required: false
    default: 'false'
  latest:
    description: 'Mark as latest release (true, false, or auto)'
    required: false
    default: 'auto'
  # Build options
  working-directory:
    description: 'Working directory'
    required: false
    default: '.'
  snapshot:
    description: 'Build snapshot (no release created)'
    required: false
    default: 'false'
  config-file:
    description: 'Path to GoReleaser config file'
    required: false
    default: '.goreleaser.yml'
  distribution:
    description: 'GoReleaser distribution (goreleaser or goreleaser-pro)'
    required: false
    default: 'goreleaser'
  parallelism:
    description: 'Number of parallel builds (empty for auto)'
    required: false
    default: ''
  skip-announce:
    description: 'Skip announce step'
    required: false
    default: 'false'
  skip-validate:
    description: 'Skip validation step'
    required: false
    default: 'false'

outputs:
  tag:
    description: 'The release tag'
    value: ${{ steps.tag.outputs.tag }}
  release-url:
    description: 'URL of the created release'
    value: ${{ steps.release-url.outputs.url }}
  artifacts:
    description: 'Built artifacts JSON'
    value: ${{ steps.goreleaser.outputs.artifacts }}
  metadata:
    description: 'Release metadata JSON'
    value: ${{ steps.goreleaser.outputs.metadata }}

runs:
  using: 'composite'
  steps:
    - name: Calculate tag
      id: tag
      shell: bash
      env:
        EXPLICIT_TAG: ${{ inputs.tag }}
        PREFIX: ${{ inputs.tag-prefix }}
        IS_PRERELEASE: ${{ inputs.prerelease }}
        IS_SNAPSHOT: ${{ inputs.snapshot }}
      run: |
        if [ "$IS_SNAPSHOT" = "true" ]; then
          echo "Snapshot mode - no tag needed"
          echo "tag=" >> $GITHUB_OUTPUT
          exit 0
        fi

        if [ -n "$EXPLICIT_TAG" ]; then
          echo "Using explicit tag: $EXPLICIT_TAG"
          echo "tag=$EXPLICIT_TAG" >> $GITHUB_OUTPUT
        elif [ "$IS_PRERELEASE" = "true" ]; then
          TODAY=$(date -u +%Y%m%d)

          echo "Checking existing tags for today..."
          EXISTING=$(git tag -l "${PREFIX}-${TODAY}-rc*" | sort -V | tail -1)

          if [ -z "$EXISTING" ]; then
            SEQ=1
          else
            CURRENT_SEQ=$(echo "$EXISTING" | sed "s/.*-rc//" | cut -d- -f1)
            SEQ=$((CURRENT_SEQ + 1))
          fi

          TAG="${PREFIX}-${TODAY}-rc${SEQ}"
          echo "Generated prerelease tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
        else
          echo "::error::Stable releases require an explicit tag"
          exit 1
        fi

    - name: Create and push tag
      if: inputs.snapshot != 'true' && steps.tag.outputs.tag != ''
      shell: bash
      env:
        TAG: ${{ steps.tag.outputs.tag }}
        IS_PRERELEASE: ${{ inputs.prerelease }}
      run: |
        # Check if tag already exists
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping tag creation"
        else
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ "$IS_PRERELEASE" = "true" ]; then
            git tag -a "$TAG" -m "Release Candidate $TAG"
          else
            git tag -a "$TAG" -m "Release $TAG"
          fi
          git push origin "$TAG"
          echo "Created and pushed tag: $TAG"
        fi

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: ${{ inputs.working-directory }}/go.mod
        cache: true
        cache-dependency-path: ${{ inputs.working-directory }}/go.sum

    - name: Build arguments
      id: args
      shell: bash
      env:
        ARGS: ${{ inputs.args }}
        SNAPSHOT: ${{ inputs.snapshot }}
        CONFIG: ${{ inputs.config-file }}
        PARALLELISM: ${{ inputs.parallelism }}
        SKIP_ANNOUNCE: ${{ inputs.skip-announce }}
        SKIP_VALIDATE: ${{ inputs.skip-validate }}
      run: |
        FINAL_ARGS=""

        if [ "$SNAPSHOT" = "true" ]; then
          FINAL_ARGS="build --snapshot --clean"
        else
          FINAL_ARGS="$ARGS"
        fi

        # Add config file if not default
        if [ "$CONFIG" != ".goreleaser.yml" ] && [ "$CONFIG" != ".goreleaser.yaml" ]; then
          FINAL_ARGS="$FINAL_ARGS --config $CONFIG"
        fi

        # Add parallelism if specified
        if [ -n "$PARALLELISM" ]; then
          FINAL_ARGS="$FINAL_ARGS --parallelism $PARALLELISM"
        fi

        # Skip options
        if [ "$SKIP_ANNOUNCE" = "true" ]; then
          FINAL_ARGS="$FINAL_ARGS --skip=announce"
        fi

        if [ "$SKIP_VALIDATE" = "true" ]; then
          FINAL_ARGS="$FINAL_ARGS --skip=validate"
        fi

        echo "args=$FINAL_ARGS" >> $GITHUB_OUTPUT
        echo "Final args: $FINAL_ARGS"

    - name: Run GoReleaser
      id: goreleaser
      uses: goreleaser/goreleaser-action@v6
      with:
        distribution: ${{ inputs.distribution }}
        version: ${{ inputs.version }}
        args: ${{ steps.args.outputs.args }}
        workdir: ${{ inputs.working-directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        GORELEASER_CURRENT_TAG: ${{ steps.tag.outputs.tag }}
        GORELEASER_PREVIOUS_TAG: ""
        # Release options passed via environment
        GORELEASER_RELEASE_DRAFT: ${{ inputs.draft }}
        GORELEASER_RELEASE_PRERELEASE: ${{ inputs.prerelease }}
        GORELEASER_MAKE_LATEST: ${{ inputs.latest }}

    - name: Get release URL
      id: release-url
      if: inputs.snapshot != 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        TAG: ${{ steps.tag.outputs.tag }}
      run: |
        if [ -n "$TAG" ]; then
          URL=$(gh release view "$TAG" --json url -q '.url' 2>/dev/null || echo "")
          echo "url=$URL" >> $GITHUB_OUTPUT
        fi
