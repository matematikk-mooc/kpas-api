# GitHub Release Action
# Creates GitHub releases (both prereleases and stable releases)
# Copy to other projects: .github/actions/_gh-release/
#
# Tag Generation (when tag input is empty):
#   - Prerelease: _stage-YYYYMMDD-rcN (underscore prefix sorts below real versions)
#   - Stable: Requires explicit tag input
#
# Usage:
#   Prerelease: prerelease: true, tag: '' (auto-generated)
#   Stable:     prerelease: false, tag: 'v1.2.3'

name: 'GitHub Release'
description: 'Create GitHub releases with support for both prereleases and stable releases'

inputs:
  github-token:
    description: 'GitHub token for creating release'
    required: true
  prerelease:
    description: 'Mark as prerelease'
    required: false
    default: 'true'
  draft:
    description: 'Create as draft release'
    required: false
    default: 'false'
  tag:
    description: 'Explicit tag name (skips auto-generation for prereleases)'
    required: false
    default: ''
  tag-prefix:
    description: 'Tag prefix for auto-generated prerelease tags'
    required: false
    default: '_stage'
  body:
    description: 'Release body content'
    required: false
    default: ''
  generate-notes:
    description: 'Auto-generate release notes from commits'
    required: false
    default: 'true'
  target-commitish:
    description: 'Target branch or commit SHA (default: current HEAD)'
    required: false
    default: ''
  files:
    description: 'Assets to upload (glob pattern, newline-separated)'
    required: false
    default: ''
  discussion-category:
    description: 'Create discussion in this category'
    required: false
    default: ''
  latest:
    description: 'Mark as latest release (true, false, or auto)'
    required: false
    default: 'auto'

outputs:
  tag:
    description: 'The created tag name'
    value: ${{ steps.create.outputs.tag }}
  release-url:
    description: 'URL of the created release'
    value: ${{ steps.create.outputs.release_url }}
  release-id:
    description: 'ID of the created release'
    value: ${{ steps.create.outputs.release_id }}
  date:
    description: 'Date component of the tag (for prereleases)'
    value: ${{ steps.calc-tag.outputs.date }}
  sequence:
    description: 'Sequence number (for prereleases)'
    value: ${{ steps.calc-tag.outputs.sequence }}

runs:
  using: 'composite'
  steps:
    - name: Calculate tag name
      id: calc-tag
      shell: bash
      env:
        EXPLICIT_TAG: ${{ inputs.tag }}
        PREFIX: ${{ inputs.tag-prefix }}
        IS_PRERELEASE: ${{ inputs.prerelease }}
      run: |
        if [ -n "$EXPLICIT_TAG" ]; then
          echo "Using explicit tag: $EXPLICIT_TAG"
          echo "tag=$EXPLICIT_TAG" >> $GITHUB_OUTPUT
          echo "date=" >> $GITHUB_OUTPUT
          echo "sequence=" >> $GITHUB_OUTPUT
        elif [ "$IS_PRERELEASE" = "true" ]; then
          TODAY=$(date -u +%Y%m%d)

          echo "Checking existing tags for today..."
          EXISTING=$(git tag -l "${PREFIX}-${TODAY}-rc*" | sort -V | tail -1)

          if [ -z "$EXISTING" ]; then
            SEQ=1
          else
            CURRENT_SEQ=$(echo "$EXISTING" | sed "s/.*-rc//" | cut -d- -f1)
            SEQ=$((CURRENT_SEQ + 1))
          fi

          TAG="${PREFIX}-${TODAY}-rc${SEQ}"
          echo "Generated tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "date=$TODAY" >> $GITHUB_OUTPUT
          echo "sequence=$SEQ" >> $GITHUB_OUTPUT
        else
          echo "::error::Stable releases require an explicit tag"
          exit 1
        fi

    - name: Create tag
      shell: bash
      env:
        TAG: ${{ steps.calc-tag.outputs.tag }}
        TARGET: ${{ inputs.target-commitish }}
        IS_PRERELEASE: ${{ inputs.prerelease }}
      run: |
        SHA="$TARGET"
        if [ -z "$SHA" ]; then
          SHA=$(git rev-parse HEAD)
        fi

        # Check if tag already exists
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping tag creation"
        else
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ "$IS_PRERELEASE" = "true" ]; then
            git tag -a "$TAG" "$SHA" -m "Release Candidate $TAG"
          else
            git tag -a "$TAG" "$SHA" -m "Release $TAG"
          fi
          git push origin "$TAG"
        fi

    - name: Generate release body
      id: body
      shell: bash
      env:
        CUSTOM_BODY: ${{ inputs.body }}
        TAG: ${{ steps.calc-tag.outputs.tag }}
        IS_PRERELEASE: ${{ inputs.prerelease }}
      run: |
        # Prereleases have empty body (just use auto-generated notes)
        # Stable releases include tag/date info
        if [ "$IS_PRERELEASE" = "true" ]; then
          echo "" > /tmp/release-body.md
        else
          {
            echo "## Release"
            echo ""
            echo "**Tag:** \`$TAG\`"
            echo "**Date:** $(date -u +%Y-%m-%d)"
            echo ""
            echo "---"
          } > /tmp/release-body.md
        fi

        # Append custom body if provided
        if [ -n "$CUSTOM_BODY" ]; then
          echo "$CUSTOM_BODY" >> /tmp/release-body.md
        fi

        {
          echo "body<<EOFBODY"
          cat /tmp/release-body.md
          echo "EOFBODY"
        } >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      id: create
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        TAG: ${{ steps.calc-tag.outputs.tag }}
        BODY: ${{ steps.body.outputs.body }}
        IS_PRERELEASE: ${{ inputs.prerelease }}
        IS_DRAFT: ${{ inputs.draft }}
        GENERATE_NOTES: ${{ inputs.generate-notes }}
        DISCUSSION_CAT: ${{ inputs.discussion-category }}
        LATEST: ${{ inputs.latest }}
        FILES: ${{ inputs.files }}
      run: |
        # Title defaults to tag name when not specified
        ARGS=(
          "$TAG"
        )

        if [ "$IS_PRERELEASE" = "true" ]; then
          ARGS+=(--prerelease)
        fi

        if [ "$IS_DRAFT" = "true" ]; then
          ARGS+=(--draft)
        fi

        if [ "$GENERATE_NOTES" = "true" ]; then
          ARGS+=(--generate-notes)
        fi

        if [ -n "$DISCUSSION_CAT" ]; then
          ARGS+=(--discussion-category "$DISCUSSION_CAT")
        fi

        if [ "$LATEST" = "true" ]; then
          ARGS+=(--latest)
        elif [ "$LATEST" = "false" ]; then
          ARGS+=(--latest=false)
        fi

        # Add files if specified
        if [ -n "$FILES" ]; then
          while IFS= read -r file_pattern; do
            file_pattern=$(echo "$file_pattern" | xargs)
            if [ -n "$file_pattern" ]; then
              for f in $file_pattern; do
                if [ -f "$f" ]; then
                  ARGS+=("$f")
                fi
              done
            fi
          done <<< "$FILES"
        fi

        RELEASE_URL=$(gh release create "${ARGS[@]}" --notes "$BODY" 2>&1)
        RELEASE_ID=$(gh release view "$TAG" --json id -q '.id')

        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
        echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT

        echo ""
        echo "Created release: $TAG"
        echo "URL: $RELEASE_URL"
