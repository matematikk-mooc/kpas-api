name: Security Audit

on:
  push:
    branches:
      - 'FIX:*'
      - 'UPDATE:*'
  pull_request:
    branches:
      - main
      - stage
  workflow_dispatch:

jobs:
  security-audit:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Node dependencies
        run: npm ci
        continue-on-error: true

      - name: Run npm Audit and format results
        run: |
          npm audit --json > npm-audit.json || true

          echo "### ðŸ“¦ npm Audit" > audit-results.md

          jq -r '.metadata.vulnerabilities |
          "Critical: ðŸš¨ \(.critical)\nHigh: âš ï¸ \(.high)\nModerate: ðŸ”§ \(.moderate)\nLow: â„¹ï¸ \(.low)\n\n---\n"' npm-audit.json >> audit-results.md

          # group details by severity
          for sev in critical high moderate low; do
            count=$(jq -r --arg sev "$sev" '[.vulnerabilities[] | select(.severity == $sev)] | length' npm-audit.json)
            if [ "$count" -gt 0 ]; then
              echo "#### ${sev^^}" >> audit-results.md
              jq -r --arg sev "$sev" '
                .vulnerabilities
                | to_entries[]
                | select(.value.severity == $sev)
                | .value
                 .via[]
                | select(type == "object")
                | "- \(.name)@\(.range) â†’ \(.title)\n  \(.url)"
              ' npm-audit.json >> audit-results.md
              echo "" >> audit-results.md
            fi
          done

          if ! grep -q "-" audit-results.md; then
            echo "âœ… No vulnerabilities found" >> audit-results.md
          fi
        continue-on-error: true

      - name: Post Audit Report as PR Comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: security-audit
          path: audit-results.md


